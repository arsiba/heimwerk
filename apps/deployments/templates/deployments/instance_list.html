{% extends "base_generic.html" %}

{% block content %}
  <div class="container py-5">

    {% if owned_Instances %}
      <div class="row g-4">
        {% for instance in owned_Instances %}
          <div class="col-md-6 col-xl-4">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body d-flex flex-column">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title mb-0 fw-bold text-primary">
                    {{ instance.name|default:"Unnamed Module" }}
                  </h5>
                  <p class="text-muted mb-1">
                    <span id="badge-{{ instance.id }}" class="badge
                                                              {% if instance.status == 'running' %}bg-success
                                                              {% elif instance.status == 'failed' or instance.status == 'exited' %}bg-danger
                                                              {% elif instance.status == 'destroyed' %}bg-dark
                                                              {% elif instance.status == 'paused' %}bg-warning text-dark
                                                              {% else %}bg-secondary{% endif %}">
                      {{ instance.status }}
                    </span>
                  </p>

                  <script>
                    (function() {
                      const instanceId = "{{ instance.id }}";
                      const badge = document.getElementById('badge-{{ instance.id }}');
                      const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                      const socketUrl = protocol + window.location.host + '/ws/status/' + instanceId + '/';
                      let socket = null;

                      function connect() {
                        // Falls bereits eine Verbindung besteht, nichts tun
                        if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                          return;
                        }

                        socket = new WebSocket(socketUrl);

                        socket.onmessage = function(e) {
                          const newStatus = e.data.trim().toLowerCase();
                          badge.textContent = newStatus;
                          badge.className = 'badge';

                          if (newStatus === 'running') badge.classList.add('bg-success');
                          else if (['failed', 'exited'].includes(newStatus)) badge.classList.add('bg-danger');
                          else if (newStatus === 'paused') badge.classList.add('bg-warning', 'text-dark');
                          else if (newStatus === 'destroyed') badge.classList.add('bg-dark');
                          else badge.classList.add('bg-secondary');
                        };

                        socket.onclose = function() {
                          console.log('Socket closed for ' + instanceId);
                        };
                      }

                    // 1. Sofort beim Laden verbinden
                      connect();

                    // 2. Re-connect wenn der User den Tab wieder öffnet
                      document.addEventListener('visibilitychange', function() {
                        if (document.visibilityState === 'visible') {
                          connect();
                        }
                      });
                    })();
                  </script>
                </div>

                <!-- Metadata -->
                <ul class="list-unstyled small text-muted mb-4">
                  <li><i class="bi bi-person me-2"></i><strong>Owner:</strong> {{ instance.owner|default:"Unknown" }}</li>
                  <li><i class="bi bi-calendar-plus me-2"></i><strong>Created:</strong> {{ instance.created_at|default:"N/A" }}</li>
                  <li><i class="bi bi-calendar-check me-2"></i><strong>Updated:</strong> {{ instance.updated_at|default:"N/A" }}</li>
                  <li><i class="bi bi-box me-2"></i><strong>Module:</strong> {{ instance.module|default:"N/A" }}</li>
                </ul>

                <!-- Actions -->
                <div class="pt-1 mt-auto d-flex">
                  <a href="{{ instance.get_absolute_url }}" class="btn btn-outline-primary btn-sm w-100">Manage</a>
                </div>
                {% if instance.status == 'running' %}
                  <div class="justify-content-between align-items-start">
                    <div class="pt-1 mt-auto d-flex gap-1">
                      <a href="http://{{ instance.get_local_resource_url }}" class="btn btn-outline-primary btn-sm w-100">Local Url</a>
                      {% if active_host.pangolin_features %}
                        <a href="https://{{ instance.get_external_resource_url }}" class="btn btn-outline-primary btn-sm w-100">Public Url</a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-warning border-warning" role="alert">
        <h5 class="alert-heading mb-1">No Deployments Found</h5>
        <p class="mb-0">You haven’t deployed any modules yet. Browse the catalog to get started.</p>
      </div>
    {% endif %}
  </div>
{% endblock %}
